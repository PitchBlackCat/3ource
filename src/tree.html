<html>
<body>
	<style>
	body {
		font-family: monospace;
	}
	#graph {
		position: absolute;
	}

	#container {
		position: absolute;
		left: 120px;
		white-space: nowrap; /*pre*/
	}

	.log {
		/*border: 1px solid blue;*/
		height: 25px;
	}
	</style>
	<script src="lib/three.min.js"></script>
	<script src="source.js"></script>
	<script src="nodes.js"></script>
	<div id="container"></div>
	<script>

	var plane = new THREE.PlaneGeometry( 20, 20 );
	var lineMaterial = new THREE.LineBasicMaterial( { color: 0x444fff, opacity: 1, linewidth: 3, vertexColors: THREE.VertexColors } );
	var materials = [];
	for (i=0;i<50;i++) {
		materials.push(new THREE.MeshBasicMaterial( { color: Math.random() * 0xffffff } ));
	}

	var scene = new THREE.Scene();
	var root = new TreeNode('/');

	var tmp = new THREE.Vector3();

	var url = '../data/test.json';
	requestLog(url, readTimeline);

	var target = new THREE.Vector3( 0, 0, 0 );

	function readTimeline(timeline) {
		t = timeline;

		function compare(a, b) {
			return b.date - a.date;
		}
		// Date order vs Ancestor order
		// timeline.sort(compare);

		u = timeline.concat()
		timeline.reverse();

		var i,il, commit, j, entry, filename;
		var added, deleted, modified;
		for (i=0;i<8;i++) { //t.length
			commit = timeline[i];
			files = commit.files;
			mods = {A:[], D:[], M:[]};
			if (!files) {
				// merge cases
				console.log(commit);
				continue;
			}
			for (j=0; j<files.length; j++) {
				entry = files[j];
				mods[entry.charAt(0)].push(entry.substring(2));
			}
			// console.log(mods);
			commit.mods = mods;
			// console.log(commit)

			var path;
			for (j=0;j<mods.A.length;j++) {
				path = mods.A[j];
				root.addPath(path);
			}

			for (j=0;j<mods.D.length;j++) {
				path = mods.D[j];
				root.removePath(path);
			}
		}

		initScene();

	}

	function initScene() {
		camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 1, 2100 );
		// camera.position.y = 150;
		camera.position.z = 500;
		camera.lookAt(target);
		scene.add(root);

		renderer = new THREE.WebGLRenderer();
		// renderer = new THREE.CanvasRenderer();
		renderer.setSize( window.innerWidth, window.innerHeight );

		document.body.appendChild( renderer.domElement );

		// moo = new THREE.Mesh(plane, material);
		// scene.add(moo);

		render();

	}


	function render() {
		var node;

		for (var i=0, il=allnodes.length;i<il;i++) {
			node = allnodes[i];

			node.position.dx *= 0.95;
			node.position.dy *= 0.95;
			node.position.x += node.position.dx;
			node.position.y += node.position.dy;

			node.start.y = -node.position.y;
			node.start.x = -node.position.x;
			node.line.geometry.verticesNeedUpdate = true;

			// tmp.copy(node.position);
			// node.position2.copy(node.position2);
			// node.position2.copy(tmp);
			// node.position2.multiplyScalar(2).sub(node.position);

		}

		root.simulate();

		renderer.render( scene, camera );
		requestAnimationFrame(render);
	}

	</script>
</body>
</html>