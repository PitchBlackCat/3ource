<!DOCTYPE html>
<html>
<meta charset="utf-8">
<body>
	<style>
	body {
		font-family: monospace;
	}

	</style>
	<canvas id="canvas"></canvas>
	<script src="test_files.js"></script>
	<script src="fs.js"></script>

	<script>
	// var files = ['test1.txt', 'test2.txt', 'test3.txt', '1/test1.txt', '1/test2.txt', '2/bla.txt', 'hoang/dang.txt'];

	var fs = new FS();

	var u = 0;
	function onNodeAdd(node) {
		// if (node.isFile()) return;
		console.log(++u);
		var graphNode = newNode(node.name, node.isFile()); // node.name
		node.graphNode = graphNode;
		node.onAdd.do(onNodeAdd);

		newEdge(this.graphNode, node.graphNode);

	}

	function onNodeRemove(node) {
		// graph.removeNode(node.graphNode);
	}

	var dnode = 0;

	fs.root.graphNode = newNode('.');

	function newNode(name, group) {
		return new Dir();
	}

	function newEdge(node1, node2) {
		node1.add(node2);
	}

	fs.root.onAdd.do(onNodeAdd);
	fs.root.onRemove.do(onNodeRemove);

	var z = 0;
	setTimeout(function() { 
		files.forEach(function(file) {
			z++;
			if (z > 400) return;
			fs.touch(file);

			// setTimeout(function() {
			// 	fs.touch(file);
			// 	console.log(z);
			// }, 100 * z)
		});
	}, 1000);

	canvas.width = innerWidth;
	canvas.height = window.innerHeight;

	ctx = canvas.getContext('2d');

	function Dir(x, y) {
		if (!x) x = (Math.random() - 0.5) * 50;
		if (!y) y = (Math.random() - 0.5) * 50;
		this.x = x;
		this.y = y;

		this.x2 = this.x;
		this.y2 = this.y;

		this.children = [];
		this.childClr = '#' + (~~(Math.random() * 0xfff)).toString(16);
	}

	Dir.prototype.add = function(child) {
		this.children.push(child);


		child.x += this.x;
		child.y += this.y;

		child.x2 = child.x;
		child.y2 = child.y;

		child.clr = this.childClr;

	}

	var root = fs.root.graphNode;


	var flatten = [];
	var links = [];

	

	function draw(c) {

		flatten.push(c);

		var i;

		for (i=0;i<c.children.length;i++) {
			d = c.children[i]

			links.push({from: c, to: d});
			draw(d);
		}
	}

	function animate(x, y) {

		ctx.save();
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		ctx.translate(canvas.width/2, canvas.height/2);
		
		var i;

		flatten = [];
		links = [];
		for (i=0;i<root.children.length;i++) {
			draw(root.children[i]);
		}

		var d;

		for (i=0;i<flatten.length;i++) {
			d = flatten[i];
			if (d.clr) ctx.fillStyle = d.clr;
			ctx.beginPath();
			ctx.arc(d.x, d.y, 5, 0, Math.PI * 2);
			ctx.fill();
		}


		// Force direct
		var j, e;
		var dx, dy;
		var d2; // distance squared
		var mx, my;


	// verlet

	// p2, p1
	// p3 = p2 + p2 - p1, p2

		for (i=flatten.length;i--;) {
			d = flatten[i];

			d.tx = d.x;
			d.ty = d.y;

			d.dx = d.x - d.x2;
			d.dy = d.y - d.y2;
		}

		// Repel
		for (i=flatten.length;i--;) {
			d = flatten[i];

			for (j=i;j--;) {
				e = flatten[j];

				repel(d, e);
			}
		}

		// repelInto(root);

		// calculate verlet
		for (i=flatten.length;i--;) {
			d = flatten[i];

			d.dx *= 0.9;
			d.dy *= 0.9;

			d.dx = d.dx > 0 ? Math.min(10, d.dx) : Math.max(-10, d.dx);
			d.dy = d.dy > 0 ? Math.min(10, d.dy) : Math.max(-10, d.dy);

			d.x += d.dx;
			d.y += d.dy;			

			d.x2 = d.tx;
			d.y2 = d.ty;

		}

		var eq = 50, eq2 = eq * eq;
		// Attraction as constrains
		for (i=0;i<links.length;i++) {
			d = links[i];
			e = d.to;
			d = d.from;
				dx = d.x - e.x;
				dy = d.y - e.y;

				d2 = dx * dx + dy * dy;

				d3 = Math.sqrt(d2);

				// && d2 < 5000
				if (d3) {
					k = (d3 - eq) / eq;
					mx = k * eq * dx / d3 * 0.2; // d3
					my = k * eq * dy / d3 * 0.2;

					// mx = 10 / d2 * 2 ;
					// my = 10 / d2 * 2 ;
					d.x -= mx;
					d.y -= my;
					e.x += mx;
					e.y += my;
				}
		}



		for (i=0;i<links.length;i++) {
			d = links[i];

			ctx.moveTo(d.from.x, d.from.y);
			ctx.lineTo(d.to.x, d.to.y);
			ctx.stroke();

		}		

		ctx.restore();
	}


	function repelInto(c) {

		var i;

		var flatten = c.children ;


		for (i=flatten.length;i--;) {
			d = flatten[i];

			for (j=i;j--;) {
				e = flatten[j];
				
				repel(d, e)
			}

			repelInto(d);
			
		}
		
	}


	function repel(d, e) {
		dx = d.x - e.x;
		dy = d.y - e.y;

		d2 = dx * dx + dy * dy;
		// d3 = Math.sqrt(d2);
		if (!d2) {
			dx = Math.random() - 0.5;
			dy = Math.random() - 0.5;
			d2 = 1;
		}
		if (d2 < 5000) {
			mx = dx / d2 * 6; // d3
			my = dy / d2 * 6;

			// mx = 10 / d2 * 2 ;
			// my = 10 / d2 * 2 ;
			d.dx += mx;
			d.dy += my;
			e.dx -= mx;
			e.dy -= my;
		}

	}

	// animate();
	setInterval(animate, 50);

	</script>
</body>
</html>